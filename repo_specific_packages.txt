#############################################
# Backend Repository-Specific Installation
# These commands run in the backend directory
# Executed line by line as sysr user
#############################################

# Create Python virtual environment
python3 -m venv venv

# Verify venv is ready before using it
sleep 2 && test -f venv/bin/activate

# Upgrade pip
source venv/bin/activate && pip install --upgrade pip

# Clone and install custom dependencies (py-doc-generator)
mkdir -p libs
git clone https://bitbucket.org/grepx/py-doc-generator.git libs/py-doc-generator

# Clone supporting GrepX libraries
git clone https://grepx-admin@bitbucket.org/grepx/py-web-libs.git libs/py-web-libs
git clone https://grepx-admin@bitbucket.org/grepx/grepx-py-sql-database-libs.git libs/grepx-py-sql-database-libs
git clone https://grepx-admin@bitbucket.org/grepx/py-utils.git libs/py-utils

# Install py-doc-generator requirements first
source venv/bin/activate && pip install -r libs/py-doc-generator/requirements.txt

# Install py-doc-generator in editable mode
source venv/bin/activate && pip install -e libs/py-doc-generator

# Install GrepX library dependencies in editable mode
source venv/bin/activate && pip install -e libs/py-web-libs
source venv/bin/activate && pip install -e libs/grepx-py-sql-database-libs
source venv/bin/activate && pip install -e libs/py-utils

# Install Orange Workflow dependencies
git clone https://bitbucket.org/grepx/orange-workflow.git libs/orangeworkflow

# Install orangeworkflow requirements first
source venv/bin/activate && pip install -r libs/orangeworkflow/requirements.txt

# Install main backend dependencies
source venv/bin/activate && pip install --no-cache-dir -r requirements.txt

# Install Firebase dependencies (if file exists)
source venv/bin/activate && test -f requirements-firebase.txt && pip install -r requirements-firebase.txt || echo "No Firebase requirements found, skipping"

# Run database migrations (if Alembic is configured)
source venv/bin/activate && test -d alembic && alembic upgrade head || echo "Alembic not configured, skipping migrations"